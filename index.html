<!DOCTYPE html>
<html>
<head>
	<title>ECharts demo</title>

	<link rel="stylesheet" type="text/css" href="css/reset.css">
	<link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">

</head>
<body>

	<div id="map-wrap" style="height: 100vw;">
		
	</div>

		
	<!-- 模态框（Modal） -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" 
							aria-hidden="true">×
					</button>
					<h4 class="modal-title" id="myModalLabel">
						单日数据可视化
					</h4>
				</div>
				<div class="modal-body">
					<iframe src="" id="today_iframe" frameborder="0" height="500px;" scrolling="no"></iframe>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" 
							data-dismiss="modal">关闭
					</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->


	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=AkdIIYA1NOzj8G9NFt9VRcVsCkgLG4FS"></script>
	<script type="text/javascript" src="js/echarts.min.js"></script>
	<script type="text/javascript" src="js/bmap.js"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>


	<script type="text/javascript">
		var data = [
		];
		var geoCoordMap = {
		}

		var type = ''
		// 2017-10-29  2017-11-04
		var date = ''
		// 0-24
		var hour = ''
		$.ajax({
			url:'http://118.89.233.100/map/index/index/byDate',
			type:'GET',
			dataType:'JSON',
			async:false,
			data:{type:'demand',date:'2017-10-30',hour:'2'},
			success:function(res) {
				console.log(res) 
				for (var i = res.data.length - 1; i >= 0; i--) {
					// res.data[i]
					geoCoordMap[''+i+''] = [res.data[i].longitude,res.data[i].latitude]
					data[i] = {
						name: ''+i+'',
						value: res.data[i].value*50
					}
				}
			}
		})

		var chart = echarts.init(document.getElementById('map-wrap'))
		// chart.showLoading();
		// chart.stopLoading();
		

		var convertData = function (data) {
		    var res = [];
		    for (var i = 0; i < data.length; i++) {
		        var geoCoord = geoCoordMap[data[i].name];
		        if (geoCoord) {
		            res.push({
		                value: geoCoord.concat(data[i].value)
		            });
		        }
		    }
		    return res;
		};

		option = {
		    title: {
		        text: '',
		        subtext: '',
		        sublink: '',
		        left: 'center',
		    },
		    tooltip : {
		        trigger: 'item'
		    },
		    bmap: {
		        center: [ 108.9397195892,34.2366513767],
		        zoom: 12,
		        roam: true,
		        mapStyle: {
		            styleJson: [
          {
                    "featureType": "land",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#212121"
                    }
          },
          {
                    "featureType": "building",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#2b2b2b"
                    }
          },
          {
                    "featureType": "highway",
                    "elementType": "all",
                    "stylers": {
                              "color": "#444444"
                    }
          },
          {
                    "featureType": "arterial",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#444444"
                    }
          },
          {
                    "featureType": "green",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#1b1b1b"
                    }
          },
          {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#181818"
                    }
          },
          {
                    "featureType": "subway",
                    "elementType": "geometry.stroke",
                    "stylers": {
                              "color": "#181818"
                    }
          },
          {
                    "featureType": "railway",
                    "elementType": "geometry",
                    "stylers": {
                              "lightness": -52
                    }
          },
          {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": {
                              "color": "#313131"
                    }
          },
          {
                    "featureType": "all",
                    "elementType": "labels.text.fill",
                    "stylers": {
                              "color": "#8b8787"
                    }
          },
          {
                    "featureType": "manmade",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#1b1b1b"
                    }
          },
          {
                    "featureType": "local",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#444444"
                    }
          },
          {
                    "featureType": "subway",
                    "elementType": "all",
                    "stylers": {
                              "lightness": -65,
                              "visibility": "off"
                    }
          },
          {
                    "featureType": "railway",
                    "elementType": "all",
                    "stylers": {
                              "lightness": -40,
                              "visibility": "off"
                    }
          },
          {
                    "featureType": "poi",
                    "elementType": "all",
                    "stylers": {
                              "color": "#8b8787",
                              "weight": "1",
                              "lightness": -29,
                              "visibility": "off"
                    }
          },
          {
                    "featureType": "highway",
                    "elementType": "labels",
                    "stylers": {
                              "visibility": "off"
                    }
          },
          {
                    "featureType": "boundary",
                    "elementType": "all",
                    "stylers": {
                              "color": "#ffffff"
                    }
          },
          {
                    "featureType": "label",
                    "elementType": "labels.text.fill",
                    "stylers": {
                              "visibility": "off"
                    }
          }
]

		        }
		    },
		    series : [
		        {
		            name: '',
		            type: 'scatter',
		            coordinateSystem: 'bmap',
		            data: convertData(data),
		            symbolSize: function (val) {
		                return val[2] / 10;
		            },
		            label: {
		                normal: {
		                    formatter: '{b}',
		                    position: 'right',
		                    show: false
		                },
		                emphasis: {
		                    show: true
		                }
		            },
		            itemStyle: {
		                normal: {
		                    color: '#01e7fc',
		                    opacity: 0.8,
		                }
		            }
		        },
		        {
		            name: '',
		            type: 'effectScatter',
		            coordinateSystem: 'bmap',
		            data: convertData(data.sort(function (a, b) {
		                return b.value - a.value;
		            }).slice(0, 6)),
		            symbolSize: function (val) {
		                return val[2] / 10;
		            },
		            showEffectOn: 'render',
		            rippleEffect: {
		                brushType: 'stroke'
		            },
		            hoverAnimation: true,
		            label: {
		                normal: {
		                    formatter: '{b}',
		                    position: 'right',
		                    show: true
		                }
		            },
		            itemStyle: {
		                normal: {
		                    color: '#01e7fc',
		                    opacity: 0.8,
		                    shadowBlur: 10,
		                    shadowColor: '#333',
		                }
		            },
		            zlevel: 1
		        }
		    ]
		};

		

		chart.setOption(option)

		
	</script>

	<!-- 具体区位折线 -->
	<script type="text/javascript">

		

		// 获取bmap對象
		var ecModel = chart._model;
		var bmap = null;
		ecModel.eachComponent('bmap', function (bmapModel) {			
			if(bmap == null){
				 bmap = bmapModel.__bmap;
			}
		});
		bmap.addEventListener("click",function(e){
			console.log(e)
			// alert('a')
            $('#today_iframe').attr('src','today.html?longitude='+e.point.lng+'&latitude='+e.point.lat+'&date='+'2017-10-29'+'&type='+'demand');
            $('#myModal').modal('show')
        });

		// todayChart.setOption(today_option)

	</script>
</body>
</html>